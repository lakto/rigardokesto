<!-- index.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Komentar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.0/dist/full.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Dashboard Komentar</h1>

    <div class="overflow-x-auto">
      <table class="table w-full bg-white shadow-md rounded-lg">
        <thead>
          <tr>
            <th class="bg-gray-200">ID</th>
            <th class="bg-gray-200">Tanggal</th>
            <th class="bg-gray-200">Nama</th>
            <th class="bg-gray-200">Email</th>
            <th class="bg-gray-200">Komentar</th>
            <th class="bg-gray-200">Slug</th>
            <th class="bg-gray-200">Status</th>
            <th class="bg-gray-200">Aksi</th>
          </tr>
        </thead>
        <tbody id="commentTable">
          <!-- Data komentar akan di-load di sini -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Ganti dengan kredensial Supabase kamu
    const SUPABASE_URL = "https://your-supabase-url.supabase.co";
    const SUPABASE_KEY = "your-supabase-secret-key";

    async function fetchComments() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/comments`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (!response.ok) {
          throw new Error('Gagal mengambil data komentar');
        }

        const comments = await response.json();
        renderComments(comments);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function fetchVerifiedUsers() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/verified_users`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (!response.ok) {
          throw new Error('Gagal mengambil data pengguna terverifikasi');
        }

        const verifiedUsers = await response.json();
        return verifiedUsers.map(user => user.email);
      } catch (error) {
        console.error('Error:', error);
        return [];
      }
    }

    async function renderComments(comments) {
      const verifiedUsers = await fetchVerifiedUsers();
      const commentTable = document.getElementById('commentTable');
      commentTable.innerHTML = '';

      comments.forEach(comment => {
        const isVerified = verifiedUsers.includes(comment.email);
        commentTable.innerHTML += `
          <tr class="${comment.hidden ? 'bg-red-50' : 'bg-green-50'}">
            <td>${comment.id}</td>
            <td>${new Date(comment.created_at).toLocaleString()}</td>
            <td>${comment.name}</td>
            <td class="${isVerified ? 'text-blue-500 font-bold' : ''}">${comment.email}</td>
            <td>${comment.description}</td>
            <td>${comment.slug}</td>
            <td>${comment.hidden ? 'Tersembunyi' : 'Tampil'}</td>
            <td>
              <button onclick="deleteComment(${comment.id})" class="btn btn-sm btn-outline btn-error">Hapus</button>
              <button onclick="toggleVisibility(${comment.id}, ${comment.hidden})" class="btn btn-sm btn-outline btn-success">
                ${comment.hidden ? 'Tampilkan' : 'Sembunyikan'}
              </button>
            </td>
          </tr>
        `;
      });
    }

    async function deleteComment(id) {
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/comments?id=eq.${id}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });
        alert('Komentar berhasil dihapus');
        fetchComments();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function toggleVisibility(id, currentStatus) {
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/comments?id=eq.${id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ hidden: !currentStatus })
        });
        alert('Status komentar diperbarui');
        fetchComments();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    fetchComments();
  </script>
</body>
</html>
