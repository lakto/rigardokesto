if(!window.SUPABASE_URL||!window.SUPABASE_KEY)throw new Error("Supabase URL and key are not set! Please configure them in the `.env` file. Copy `.env.example` and rename it to `.env`. Do not set values in `.env.example`!");const db=supabase.createClient(window.SUPABASE_URL,window.SUPABASE_KEY),ls_user_key="COMMENT_USER";let comments_shown=!1;const COMMENT_ITEM_TEMPLATE=get_template("comment-list-item-[[id]]"),REPLY_ITEM_TEMPLATE=get_template("reply-list-item-[[id]]"),REPLY_CONTAINER_TEMPLATE=get_template("reply-list-container-[[id]]"),BLACKLISTED_WORDS=["stupid","idiot","dumb","moron","jerk","ugly","loser","freak","psycho","trash","scum","pathetic","worthless","horrible","crazy","insane","lazy","weird","clown","annoying","click here","free","promo","discount","best","cheap","contact now","sign up here","guaranteed","join group","like and subscribe","follow me","whatsapp me","get rich quick","money transfer","win a prize","easy investment","quick loan","https://","http://"];async function send_comment(e){e.preventDefault();const t=e.target||e.currentTarget;if(!t)return;const n=new FormData(t),o=n.get("name")?.toString(),r=n.get("email")?.toString(),a=n.get("description")?.toString(),l=n.get("reply_to")?.toString()||null;if(!o||!a)return void alert("Please fill in your name and comment.");for(const e of BLACKLISTED_WORDS)if(a.toLowerCase().includes(e.toLowerCase()))return void alert("Your comment contains prohibited words.");const i=t.elements.submit;if(!i.disabled)try{i.disabled=!0,i.innerHTML='<span class="loading loading-dots loading-md"></span>';const{error:e}=await db.from("comments").insert({slug:location.pathname,name:o,email:r,description:a,reply_to:l});if(e)throw new Error("Server error");t.elements.description.value="";const n=document.createElement("p");n.className="text-success mt-4",n.innerText="Your comment has been submitted. Thank you for your participation!",t.appendChild(n),setTimeout((()=>n.remove()),5e3),comments_shown&&(l?load_replies(l).catch(console.error):load_comments().catch(console.error)),update_comment_count(),localStorage.setItem(ls_user_key,JSON.stringify({name:o,email:r}))}catch(e){console.error(`An error occurred while submitting the comment: ${e.message||"Unknown error"}`),alert("Failed to submit the comment.")}finally{i.disabled=!1,i.innerHTML=l?"Reply":"Send"}}async function load_comments(){const e=document.getElementById("comment-list-container");if(!e)return void console.warn("Comment list container element was null");const{data:t,error:n}=await db.from("comments_view").select("id,name,description,created_at,verified").eq("slug",location.pathname).is("reply_to",null).order("created_at",{ascending:!1});if(n)throw n;if(t?.length){e.innerHTML="";for(const n of t){n.relative_time=relative_time(n.created_at),n.created_at=new Date(n.created_at).toLocaleString();const t=replace_placeholders(COMMENT_ITEM_TEMPLATE,n);e.appendChild(t)}}else e.innerHTML="No comments yet. Be the first to comment."}function reply_comment(e){const t=e.dataset.commentId,n=`comment-reply-${t}`,o=document.getElementById(n);if(o)return o.nextElementSibling.remove(),o.remove(),void(e.innerText="Reply");const r=document.getElementById("comment-form");if(!r)return;const a=r.cloneNode(!0);a.id=n,a.classList?.add("pl-4","mt-4"),a.elements.submit.innerText="Reply",a.elements.reply_to.value=t,a.onsubmit=send_comment;const l=document.getElementById(`comment-list-item-${t}`);l?.insertAdjacentElement("afterend",a),e.innerText="Hide reply",load_replies(t).catch(console.error)}async function load_replies(e){const t=document.getElementById(`comment-reply-${e}`);if(!t)return;const n=document.createElement("div");n.innerHTML='<span class="loading loading-dots loading-md ml-5"></span>',t.insertAdjacentElement("afterend",n);const{data:o,error:r}=await db.from("comments_view").select("name,description,created_at,verified").eq("slug",location.pathname).eq("reply_to",e).order("created_at",{ascending:!1});if(r)throw r;if(!o?.length)return void(n.innerHTML='<em class="text-sm ml-5">No reply</em>');n.remove();const a=`reply-list-container-${e}`;document.getElementById(a)?.remove();const l=replace_placeholders(REPLY_CONTAINER_TEMPLATE,{id:e});for(const e of o){e.relative_time=relative_time(e.created_at),e.created_at=new Date(e.created_at).toLocaleString();const t=replace_placeholders(REPLY_ITEM_TEMPLATE,e);l.appendChild(t)}t.insertAdjacentElement("afterend",l)}async function see_comments(e){const t=e.currentTarget||e.target;if(t)try{t.disabled=!0,t.innerHTML='<span class="loading loading-dots loading-md"></span>',await load_comments(),comments_shown=!0,t.classList.add("hidden")}catch(e){console.error(`An error occurred while loading comments: ${e.message||"Unknown error"}`),alert("Failed to load comments.")}finally{t.disabled=!1,t.innerHTML="See all comments"}}async function update_comment_count(){const e=document.querySelectorAll(".indicator-item");if(e.length)try{const{count:t,error:n}=await db.from("comments").select("*",{count:"exact",head:!0}).eq("slug",location.pathname).or("hidden.is.null,hidden.eq.false");if(n)throw n;const o=t>99?"99+":t?.toString()||"0";e.forEach((e=>{t>0?(e.textContent=o,e.classList.remove("hidden")):e.classList.add("hidden")}))}catch(t){console.error("Failed to update comment count:",t.message||t),e.forEach((e=>{e.classList.add("hidden")}))}}function replace_placeholders(e,t){const n=new String(e).replace(/\[\[([^\]]+)\]\]/g,((e,n)=>{let o=!1;n.startsWith("!")&&(o=!0,n=n.slice(1));let r=n in t?t[n]:"";return o&&(r=!r),r}));return(new DOMParser).parseFromString(n,"text/html").body.firstElementChild}function get_template(e){const t=document.getElementById(e);if(!t)throw new Error(`Template with given id (#${e}) was not found`);const n=t.cloneNode(!0);return n.hidden=!1,t.remove(),n.outerHTML}function relative_time(e){e="string"==typeof e?new Date(e):e;const t=new Date,n=Math.floor((t-e)/1e3),o=[{label:"second",value:1},{label:"minute",value:60},{label:"hour",value:3600},{label:"day",value:86400},{label:"month",value:2592e3},{label:"year",value:31536e3}];for(let e=o.length-1;e>=0;e--){const t=o[e].value,r=o[e].label;if(n>=t){const e=Math.floor(n/t);return`${e} ${1!==e?`${r}s`:r} ago`}}return"Just now"}window.addEventListener("load",(()=>{const e=document.getElementById("comment-form");e.onsubmit=async e=>{await send_comment(e),await update_comment_count()};const t=JSON.parse(localStorage.getItem(ls_user_key)||"{}");e.elements.name.value=t.name||"",e.elements.email.value=t.email||"";document.getElementById("comment-list-loader").onclick=see_comments,update_comment_count()}));